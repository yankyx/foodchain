<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿç‰©é“¾æ­å»ºæ¨¡æ‹Ÿå™¨</title>
    <!-- ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æœ¬åœ°å®‰è£…çš„Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                        neutral: '#86909C',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .drag-item {
                @apply cursor-move transition-all duration-200 hover:scale-110 hover:shadow-lg;
            }
            .drop-zone {
                @apply border-2 border-dashed border-primary/30 transition-all duration-200;
            }
            .drop-zone-active {
                @apply border-primary bg-primary/5;
            }
            .creature-icon {
                @apply flex items-center justify-center w-14 h-14 text-3xl bg-white rounded-full shadow-md transition-all duration-300 hover:shadow-lg;
            }
            .btn-level {
                @apply px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium;
            }
            .btn-level-active {
                @apply bg-primary text-white;
            }
            .btn-level-inactive {
                @apply bg-gray-100 text-gray-600 hover:bg-gray-200;
            }
        }
        /* ä¿®å¤CSSå…¼å®¹æ€§è­¦å‘Š */
        :host, html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col overflow-hidden">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow-sm py-3 px-4 sm:px-6 lg:px-8 flex items-center justify-between z-10">
        <div class="flex items-center space-x-2">
            <i class="fa fa-link text-primary text-xl"></i>
            <h1 class="text-[clamp(1.2rem,3vw,1.8rem)] font-bold text-gray-900">é£Ÿç‰©é“¾æ­å»ºæ¨¡æ‹Ÿå™¨</h1>
        </div>
        <div id="info-panel" class="text-sm text-gray-600 bg-blue-50 px-3 py-1.5 rounded-md hidden items-center space-x-1 max-w-xs">
            <i class="fa fa-info-circle text-primary"></i>
            <span id="info-message">å°†è¢«æ•é£Ÿè€…æ‹–æ‹½åˆ°æ•é£Ÿè€…ä¸Šå»ºç«‹å…³ç³»</span>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 md:p-4 gap-3">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="w-full md:w-72 bg-white rounded-lg shadow-sm p-4 flex flex-col gap-4 overflow-hidden">
            <!-- å…³å¡é€‰æ‹© -->
            <div class="space-y-2">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fa fa-list-ol text-primary mr-2"></i>å…³å¡é€‰æ‹©
                </h2>
                <div id="level-selector" class="grid grid-cols-5 gap-2 max-h-28 overflow-y-auto p-1 bg-gray-50 rounded-md">
                    <!-- å…³å¡æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="check-btn" class="w-full mt-2 bg-primary hover:bg-primary/90 text-white py-2 rounded-md transition-all duration-200 flex items-center justify-center gap-2">
                    <i class="fa fa-check-circle"></i>
                    <span>æ£€æŸ¥é£Ÿç‰©é“¾</span>
                </button>
            </div>

            <!-- ç”Ÿç‰©é€‰æ‹©åŒº -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center mb-2">
                    <i class="fa fa-paw text-primary mr-2"></i>å¯ç”¨ç”Ÿç‰©
                </h2>
                <div id="creatures-container" class="flex-1 grid grid-cols-3 sm:grid-cols-4 gap-2 p-2 bg-gray-50 rounded-md overflow-y-auto">
                    <!-- ç”Ÿç‰©å›¾æ ‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç”»å¸ƒ -->
        <div class="flex-1 bg-white rounded-lg shadow-sm p-3 overflow-hidden flex flex-col">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center mb-2 px-2">
                <i class="fa fa-draw-polygon text-primary mr-2"></i>ç”»å¸ƒåŒºåŸŸ
            </h2>
            <div id="canvas" class="flex-1 drop-zone rounded-md relative overflow-auto bg-gray-50">
                <!-- ç”Ÿç‰©å’Œè¿çº¿å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="mt-2 text-xs text-gray-500 flex items-center justify-between px-2">
                <span>æç¤º: ä»å·¦ä¾§æ‹–æ‹½ç”Ÿç‰©åˆ°ç”»å¸ƒï¼Œç„¶åå°†è¢«æ•é£Ÿè€…æ‹–æ‹½åˆ°æ•é£Ÿè€…ä¸Š</span>
                <span id="level-info">å½“å‰å…³å¡: ç¬¬1å…³</span>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <footer class="bg-white shadow-sm py-2 px-4 text-sm text-gray-500 flex items-center justify-between">
        <div>é£Ÿç‰©é“¾æ­å»ºæ¨¡æ‹Ÿå™¨ &copy; 2023</div>
        <div id="status-bar">å‡†å¤‡å°±ç»ª</div>
    </footer>

    <script>
        // ç”Ÿç‰©æ•°æ® - 40ç§ç”Ÿç‰©
        const creaturesData = [
            { id: 1, name: 'è‰', emoji: 'ğŸŒ¿', type: 'producer', prey: [] },
            { id: 2, name: 'å…”å­', emoji: 'ğŸ°', type: 'consumer', prey: [1] },
            { id: 3, name: 'ç‹ç‹¸', emoji: 'ğŸ¦Š', type: 'consumer', prey: [2] },
            { id: 4, name: 'ç‹®å­', emoji: 'ğŸ¦', type: 'consumer', prey: [2, 3] },
            { id: 5, name: 'è€é¼ ', emoji: 'ğŸ­', type: 'consumer', prey: [1] },
            { id: 6, name: 'è›‡', emoji: 'ğŸ', type: 'consumer', prey: [2, 5] },
            { id: 7, name: 'é¹°', emoji: 'ğŸ¦…', type: 'consumer', prey: [2, 5, 6] },
            { id: 8, name: 'èš‚èš', emoji: 'ğŸœ', type: 'consumer', prey: [1] },
            { id: 9, name: 'èœ˜è››', emoji: 'ğŸ•·ï¸', type: 'consumer', prey: [8] },
            { id: 10, name: 'é¸Ÿ', emoji: 'ğŸ¦', type: 'consumer', prey: [8] },
            { id: 11, name: 'é±¼', emoji: 'ğŸŸ', type: 'consumer', prey: [12] },
            { id: 12, name: 'æµ®æ¸¸ç”Ÿç‰©', emoji: 'ğŸ¦ ', type: 'producer', prey: [] },
            { id: 13, name: 'é’è›™', emoji: 'ğŸ¸', type: 'consumer', prey: [8, 10] },
            { id: 14, name: 'é³„é±¼', emoji: 'ğŸŠ', type: 'consumer', prey: [2, 13, 15] },
            { id: 15, name: 'é¹¿', emoji: 'ğŸ¦Œ', type: 'consumer', prey: [1] },
            { id: 16, name: 'ç‹¼', emoji: 'ğŸº', type: 'consumer', prey: [2, 15] },
            { id: 17, name: 'ç†Š', emoji: 'ğŸ»', type: 'consumer', prey: [2, 3, 15] },
            { id: 18, name: 'èœœèœ‚', emoji: 'ğŸ', type: 'consumer', prey: [1] },
            { id: 19, name: 'è´è¶', emoji: 'ğŸ¦‹', type: 'consumer', prey: [1] },
            { id: 20, name: 'çŒ«å¤´é¹°', emoji: 'ğŸ¦‰', type: 'consumer', prey: [5, 9] },
            { id: 21, name: 'èœˆèš£', emoji: 'ğŸ›', type: 'consumer', prey: [8] },
            { id: 22, name: 'èœ¥èœ´', emoji: 'ğŸ¦', type: 'consumer', prey: [8, 21] },
            { id: 23, name: 'é¾Ÿ', emoji: 'ğŸ¢', type: 'consumer', prey: [12, 11] },
            { id: 24, name: 'è™¾', emoji: 'ğŸ¦', type: 'consumer', prey: [12] },
            { id: 25, name: 'èŸ¹', emoji: 'ğŸ¦€', type: 'consumer', prey: [12, 24] },
            { id: 26, name: 'ç« é±¼', emoji: 'ğŸ™', type: 'consumer', prey: [11, 24, 25] },
            { id: 27, name: 'æµ·é¸Ÿ', emoji: 'ğŸ¦â€â¬›', type: 'consumer', prey: [11, 24] },
            { id: 28, name: 'è±¹å­', emoji: 'ğŸ†', type: 'consumer', prey: [2, 15] },
            { id: 29, name: 'å¤§è±¡', emoji: 'ğŸ˜', type: 'consumer', prey: [1] },
            { id: 30, name: 'çŠ€ç‰›', emoji: 'ğŸ¦', type: 'consumer', prey: [1] },
            { id: 31, name: 'æ²³é©¬', emoji: 'ğŸ¦›', type: 'consumer', prey: [1] },
            { id: 32, name: 'é•¿é¢ˆé¹¿', emoji: 'ğŸ¦’', type: 'consumer', prey: [1] },
            { id: 33, name: 'æ–‘é©¬', emoji: 'ğŸ¦“', type: 'consumer', prey: [1] },
            { id: 34, name: 'çŒ´å­', emoji: 'ğŸ’', type: 'consumer', prey: [1] },
            { id: 35, name: 'çŒ©çŒ©', emoji: 'ğŸ¦§', type: 'consumer', prey: [1] },
            { id: 36, name: 'ç†ŠçŒ«', emoji: 'ğŸ¼', type: 'consumer', prey: [1] },
            { id: 37, name: 'è¢‹é¼ ', emoji: 'ğŸ¦˜', type: 'consumer', prey: [1] },
            { id: 38, name: 'è€ƒæ‹‰', emoji: 'ğŸ¨', type: 'consumer', prey: [1] },
            { id: 39, name: 'ä¼é¹…', emoji: 'ğŸ§', type: 'consumer', prey: [11, 24] },
            { id: 40, name: 'é²¸é±¼', emoji: 'ğŸ‹', type: 'consumer', prey: [11, 24, 26] }
        ];

        // å…³å¡æ•°æ® - 10å…³
        const levels = Array.from({ length: 10 }, (_, i) => ({
            level: i + 1,
            creatureCount: 4 + i * 2,
            creatureIds: creaturesData.slice(0, 4 + i * 2).map(c => c.id)
        }));

        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            currentLevel: 1,
            canvasCreatures: new Map(), // id -> {element, x, y}
            connections: new Set(), // Set of strings "preyId-predatorId"
            draggingElement: null,
            draggedCreatureId: null
        };

        // DOMå…ƒç´ 
        const levelSelector = document.getElementById('level-selector');
        const creaturesContainer = document.getElementById('creatures-container');
        const canvas = document.getElementById('canvas');
        const checkBtn = document.getElementById('check-btn');
        const statusBar = document.getElementById('status-bar');
        const levelInfo = document.getElementById('level-info');
        const infoPanel = document.getElementById('info-panel');
        const infoMessage = document.getElementById('info-message');

        // åˆå§‹åŒ–å…³å¡é€‰æ‹©å™¨
        function initLevelSelector() {
            levelSelector.innerHTML = '';
            levels.forEach(level => {
                const button = document.createElement('button');
                button.className = `btn-level ${level.level === gameState.currentLevel ? 'btn-level-active' : 'btn-level-inactive'}`;
                button.textContent = level.level;
                button.addEventListener('click', () => { if (level.level !== gameState.currentLevel) switchLevel(level.level); });
                levelSelector.appendChild(button);
            });
        }

        // åˆ‡æ¢å…³å¡
        function switchLevel(levelNum) {
            if (levelNum < 1 || levelNum > levels.length) return;

            // æ¸…ç©ºç”»å¸ƒ
            canvas.innerHTML = '';
            gameState.canvasCreatures.clear();
            gameState.connections.clear();

            // æ›´æ–°å½“å‰å…³å¡
            gameState.currentLevel = levelNum;
            levelInfo.textContent = `å½“å‰å…³å¡: ç¬¬${levelNum}å…³`;

            // æ›´æ–°å…³å¡æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn-level').forEach((btn, i) => {
                btn.className = `btn-level ${(i + 1) === levelNum ? 'btn-level-active' : 'btn-level-inactive'}`;
            });

            // æ›´æ–°å¯ç”¨ç”Ÿç‰©
            updateCreaturesContainer();

            // æ›´æ–°çŠ¶æ€æ 
            showStatus(`å·²åˆ‡æ¢åˆ°ç¬¬${levelNum}å…³ï¼ŒåŒ…å«${levels[levelNum - 1].creatureCount}ç§ç”Ÿç‰©`);
        }

        // æ›´æ–°ç”Ÿç‰©é€‰æ‹©å®¹å™¨
        function updateCreaturesContainer() {
            creaturesContainer.innerHTML = '';
            const currentLevelCreatures = levels[gameState.currentLevel - 1].creatureIds;

            creaturesData
                .filter(creature => currentLevelCreatures.includes(creature.id))
                .forEach(creature => {
                    const creatureElement = createCreatureElement(creature, false);
                    creatureElement.classList.add('drag-item');

                    // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                    creatureElement.setAttribute('draggable', 'true');
                    creatureElement.addEventListener('dragstart', (e) => {
                        gameState.draggingElement = creatureElement;
                        gameState.draggedCreatureId = creature.id;
                        e.dataTransfer.setData('text/plain', creature.id);
                        setTimeout(() => creatureElement.classList.add('opacity-50'), 0);
                    });

                    creatureElement.addEventListener('dragend', () => {
                        gameState.draggingElement = null;
                        gameState.draggedCreatureId = null;
                        creatureElement.classList.remove('opacity-50');
                    });

                    creaturesContainer.appendChild(creatureElement);
                });
        }

        // åˆ›å»ºç”Ÿç‰©å…ƒç´ 
        function createCreatureElement(creature, isOnCanvas = true) {
            const container = document.createElement('div');
            container.className = 'relative';
            container.dataset.creatureId = creature.id;
            container.dataset.creatureName = creature.name;

            const icon = document.createElement('div');
            icon.className = 'creature-icon';
            icon.textContent = creature.emoji;
            icon.title = creature.name;

            const name = document.createElement('div');
            name.className = 'text-xs text-center mt-1 whitespace-nowrap';
            name.textContent = creature.name;

            container.appendChild(icon);
            container.appendChild(name);

            if (isOnCanvas) {
                // ç”»å¸ƒä¸Šçš„ç”Ÿç‰©å¯ä»¥æ‹–åŠ¨
                makeDraggable(container);
            }

            return container;
        }

        // ä½¿å…ƒç´ å¯æ‹–åŠ¨
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // è·å–é¼ æ ‡ä½ç½®
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // è®¡ç®—æ–°ä½ç½®
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // è®¾ç½®æ–°ä½ç½®
                const creatureId = parseInt(element.dataset.creatureId);
                const creature = gameState.canvasCreatures.get(creatureId);
                if (creature) {
                    creature.x = creature.element.offsetLeft - pos1;
                    creature.y = creature.element.offsetTop - pos2;
                    creature.element.style.left = `${creature.x}px`;
                    creature.element.style.top = `${creature.y}px`;
                    // æ›´æ–°è¿çº¿
                    updateConnections();
                }
            }

            function closeDragElement() {
                // åœæ­¢ç§»åŠ¨
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // åˆå§‹åŒ–ç”»å¸ƒæ‹–æ‹½äº‹ä»¶
        function initCanvasDrop() {
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                canvas.classList.add('drop-zone-active');
            });

            canvas.addEventListener('dragleave', () => {
                canvas.classList.remove('drop-zone-active');
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                canvas.classList.remove('drop-zone-active');

                const creatureId = parseInt(e.dataTransfer.getData('text/plain'));
                if (isNaN(creatureId)) return;

                // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç”»å¸ƒä¸Š
                if (gameState.canvasCreatures.has(creatureId)) {
                    showStatus('è¿™ç§ç”Ÿç‰©å·²ç»åœ¨ç”»å¸ƒä¸Šäº†');
                    return;
                }

                // è·å–é¼ æ ‡åœ¨ç”»å¸ƒä¸Šçš„ä½ç½®
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - 30; // å±…ä¸­
                const y = e.clientY - rect.top - 30;  // å±…ä¸­

                // åˆ›å»ºå¹¶æ·»åŠ ç”Ÿç‰©åˆ°ç”»å¸ƒ
                const creature = creaturesData.find(c => c.id === creatureId);
                if (creature) {
                    const creatureElement = createCreatureElement(creature);
                    creatureElement.style.position = 'absolute';
                    creatureElement.style.left = `${x}px`;
                    creatureElement.style.top = `${y}px`;

                    canvas.appendChild(creatureElement);
                    gameState.canvasCreatures.set(creatureId, {
                        element: creatureElement,
                        x: x,
                        y: y
                    });

                    // æ·»åŠ æ‹–æ”¾äº‹ä»¶ï¼ˆç”¨äºè¿æ¥ç”Ÿç‰©ï¼‰
                    creatureElement.setAttribute('draggable', 'true');
                    creatureElement.addEventListener('dragstart', (e) => {
                        gameState.draggingElement = creatureElement;
                        gameState.draggedCreatureId = creatureId;
                        e.dataTransfer.setData('text/plain', creatureId);
                        setTimeout(() => creatureElement.classList.add('opacity-50'), 0);
                    });

                    creatureElement.addEventListener('dragend', () => {
                        gameState.draggingElement = null;
                        gameState.draggedCreatureId = null;
                        creatureElement.classList.remove('opacity-50');
                    });

                    creatureElement.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (gameState.draggingElement && gameState.draggingElement !== creatureElement) {
                            creatureElement.classList.add('ring-2', 'ring-primary');
                        }
                    });

                    creatureElement.addEventListener('dragleave', () => {
                        creatureElement.classList.remove('ring-2', 'ring-primary');
                    });

                    creatureElement.addEventListener('drop', (e) => {
                        e.preventDefault();
                        creatureElement.classList.remove('ring-2', 'ring-primary');

                        const preyId = parseInt(e.dataTransfer.getData('text/plain'));
                        if (isNaN(preyId)) return;

                        // æ•é£Ÿè€…ID
                        const predatorId = parseInt(creatureElement.dataset.creatureId);

                        // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ç”Ÿç‰©
                        if (preyId === predatorId) {
                            showInfo(`ç”Ÿç‰©ä¸èƒ½æ•é£Ÿè‡ªå·±`);
                            return;
                        }

                        // æ£€æŸ¥æ•é£Ÿå…³ç³»
                        const predator = creaturesData.find(c => c.id === predatorId);
                        const prey = creaturesData.find(c => c.id === preyId);

                        if (predator && prey && predator.prey.includes(preyId)) {
                            // æœ‰æ•ˆæ•é£Ÿå…³ç³»
                            const connectionKey = `${preyId}-${predatorId}`;
                            if (!gameState.connections.has(connectionKey)) {
                                gameState.connections.add(connectionKey);
                                createConnection(preyId, predatorId);
                                showInfo(`${prey.name} è¢« ${predator.name} æ•é£Ÿ`);
                            } else {
                                showInfo(`è¿™ç§æ•é£Ÿå…³ç³»å·²ç»å­˜åœ¨`);
                            }
                        } else {
                            // æ— æ•ˆæ•é£Ÿå…³ç³»
                            showInfo(`${predator?.name || 'æœªçŸ¥ç”Ÿç‰©'} ä¸èƒ½æ•é£Ÿ ${prey?.name || 'æœªçŸ¥ç”Ÿç‰©'}`);
                        }
                    });

                    showStatus(`å·²æ·»åŠ  ${creature.name} åˆ°ç”»å¸ƒ`);
                }
            });
        }

        // åˆ›å»ºè¿æ¥
        function createConnection(preyId, predatorId) {
            // æ£€æŸ¥ç”Ÿç‰©æ˜¯å¦å­˜åœ¨
            const prey = gameState.canvasCreatures.get(preyId);
            const predator = gameState.canvasCreatures.get(predatorId);
            if (!prey || !predator) return;

            // åˆ›å»ºSVGå®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let svg = document.querySelector('#canvas-svg');
            if (!svg) {
                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.id = 'canvas-svg';
                svg.className = 'absolute top-0 left-0 w-full h-full pointer-events-none';
                canvas.appendChild(svg);
            }

            // åˆ›å»ºè¿æ¥çº¿ID
            const lineId = `connection-${preyId}-${predatorId}`;

            // æ£€æŸ¥çº¿æ˜¯å¦å·²å­˜åœ¨
            if (document.getElementById(lineId)) return;

            // åˆ›å»ºçº¿
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.id = lineId;
            line.className = 'stroke-primary stroke-2';
            line.dataset.preyId = preyId;
            line.dataset.predatorId = predatorId;

            // æ›´æ–°çº¿çš„ä½ç½®
            updateLinePosition(line, preyId, predatorId);

            // æ·»åŠ ç®­å¤´æ ‡è®°
            const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            if (!svg.querySelector('defs')) {
                svg.appendChild(defs);
            }

            if (!defs.querySelector('#arrowhead')) {
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.id = 'arrowhead';
                marker.viewBox = '0 0 10 10';
                marker.refX = '8';
                marker.refY = '5';
                marker.markerWidth = '6';
                marker.markerHeight = '6';
                marker.orient = 'auto';

                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.points = '0 0, 10 5, 0 10';
                polygon.fill = '#165DFF';

                marker.appendChild(polygon);
                defs.appendChild(marker);
            }

            line.setAttribute('marker-end', 'url(#arrowhead)');
            svg.appendChild(line);
        }

        // æ›´æ–°è¿æ¥çº¿ä½ç½®
        function updateLinePosition(line, preyId, predatorId) {
            const prey = gameState.canvasCreatures.get(preyId);
            const predator = gameState.canvasCreatures.get(predatorId);
            if (!prey || !predator) return;

            // ç”Ÿç‰©å›¾æ ‡çš„ä¸­å¿ƒç‚¹
            const preyX = prey.x + 28; // 28 = 56/2 (width/2)
            const preyY = prey.y + 28; // 28 = 56/2 (height/2)
            const predatorX = predator.x + 28;
            const predatorY = predator.y + 28;

            // è®¡ç®—ç®­å¤´ä¸ç´§è´´å›¾æ ‡çš„ä½ç½®
            const dx = predatorX - preyX;
            const dy = predatorY - preyY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // ä» prey å‡ºå‘ï¼Œè·ç¦»å›¾æ ‡è¾¹ç¼˜ä¸€å®šè·ç¦»çš„ç‚¹
            const startOffset = 20; // è·ç¦»å›¾æ ‡è¾¹ç¼˜çš„è·ç¦»
            const startX = preyX + (dx / distance) * startOffset;
            const startY = preyY + (dy / distance) * startOffset;

            // åˆ° predator ä¸ºæ­¢ï¼Œè·ç¦»å›¾æ ‡è¾¹ç¼˜ä¸€å®šè·ç¦»çš„ç‚¹
            const endOffset = 20; // è·ç¦»å›¾æ ‡è¾¹ç¼˜çš„è·ç¦»
            const endX = predatorX - (dx / distance) * endOffset;
            const endY = predatorY - (dy / distance) * endOffset;

            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX);
            line.setAttribute('y2', endY);
        }

        // æ›´æ–°æ‰€æœ‰è¿æ¥çº¿
        function updateConnections() {
            const svg = document.querySelector('#canvas-svg');
            if (!svg) return;

            const lines = svg.querySelectorAll('line');
            lines.forEach(line => {
                const preyId = parseInt(line.dataset.preyId);
                const predatorId = parseInt(line.dataset.predatorId);
                updateLinePosition(line, preyId, predatorId);
            });
        }

        // æ£€æŸ¥é£Ÿç‰©é“¾æ˜¯å¦å®Œæ•´
        function checkFoodChain() {
            if (gameState.canvasCreatures.size === 0) {
                showStatus('ç”»å¸ƒä¸Šæ²¡æœ‰ç”Ÿç‰©ï¼Œè¯·æ·»åŠ ç”Ÿç‰©åå†æ£€æŸ¥');
                return;
            }

            const currentLevel = levels[gameState.currentLevel - 1];
            const requiredCreatures = currentLevel.creatureIds;
            const canvasCreatureIds = Array.from(gameState.canvasCreatures.keys());

            // æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ‰€æœ‰å¿…è¦çš„ç”Ÿç‰©
            const missingCreatures = requiredCreatures.filter(id => !canvasCreatureIds.includes(id));
            if (missingCreatures.length > 0) {
                const missingNames = missingCreatures.map(id => creaturesData.find(c => c.id === id)?.name || 'æœªçŸ¥ç”Ÿç‰©').join(', ');
                showStatus(`è¯·æ·»åŠ ä»¥ä¸‹ç”Ÿç‰©: ${missingNames}`);
                return;
            }

            // æ„å»ºé£Ÿç‰©ç½‘å›¾
            const foodWeb = new Map();
            requiredCreatures.forEach(id => {
                foodWeb.set(id, { prey: new Set(), predators: new Set() });
            });

            // æ·»åŠ è¿æ¥
            gameState.connections.forEach(connection => {
                const [preyId, predatorId] = connection.split('-').map(Number);
                if (foodWeb.has(preyId) && foodWeb.has(predatorId)) {
                    foodWeb.get(predatorId).prey.add(preyId);
                    foodWeb.get(preyId).predators.add(predatorId);
                }
            });

            // æ£€æŸ¥ç”Ÿäº§è€…æ˜¯å¦æ²¡æœ‰è¢«æ•é£Ÿè€…ï¼ˆé™¤éæ˜¯æ›´é«˜å±‚çº§çš„ç”Ÿç‰©ï¼‰
            const producers = requiredCreatures.filter(id => creaturesData.find(c => c.id === id)?.type === 'producer');
            const consumers = requiredCreatures.filter(id => creaturesData.find(c => c.id === id)?.type === 'consumer');

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯
            if (hasCycle(foodWeb)) {
                showStatus('é£Ÿç‰©é“¾ä¸­å­˜åœ¨å¾ªç¯ï¼Œè¿™æ˜¯ä¸åˆç†çš„');
                playSound(false);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ¶ˆè´¹è€…éƒ½æœ‰é£Ÿç‰©æ¥æº
            let allConsumersHaveFood = true;
            consumers.forEach(id => {
                const creature = creaturesData.find(c => c.id === id);
                const possiblePrey = creature.prey.filter(preyId => requiredCreatures.includes(preyId));
                const hasFood = possiblePrey.some(preyId => foodWeb.get(id).prey.has(preyId));
                if (!hasFood) {
                    allConsumersHaveFood = false;
                    showStatus(`${creature.name} æ²¡æœ‰é£Ÿç‰©æ¥æº`);
                }
            });

            if (!allConsumersHaveFood) {
                playSound(false);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ„å»ºäº†å®Œæ•´çš„é£Ÿç‰©ç½‘
            // ç®€å•ç‰ˆæœ¬ï¼šæ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªç”Ÿäº§è€…è¿æ¥åˆ°è‡³å°‘ä¸€ä¸ªæ¶ˆè´¹è€…
            let hasProducerConsumerConnection = false;
            producers.forEach(producerId => {
                if (foodWeb.get(producerId).predators.size > 0) {
                    hasProducerConsumerConnection = true;
                }
            });

            if (!hasProducerConsumerConnection) {
                showStatus('è¯·è¿æ¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…');
                playSound(false);
                return;
            }

            // æ‰€æœ‰æ£€æŸ¥é€šè¿‡
            showStatus('æ­å–œï¼æ‚¨å·²æ„å»ºäº†ä¸€ä¸ªæœ‰æ•ˆçš„é£Ÿç‰©é“¾');
            playSound(true);
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯
        function hasCycle(foodWeb) {
            const visited = new Set();
            const recursionStack = new Set();

            function dfs(node) {
                if (!visited.has(node)) {
                    visited.add(node);
                    recursionStack.add(node);

                    const predators = Array.from(foodWeb.get(node).predators);
                    for (const predator of predators) {
                        if (!visited.has(predator) && dfs(predator)) {
                            return true;
                        } else if (recursionStack.has(predator)) {
                            return true;
                        }
                    }
                }
                recursionStack.delete(node);
                return false;
            }

            for (const node of foodWeb.keys()) {
                if (dfs(node)) {
                    return true;
                }
            }
            return false;
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playSound(isSuccess) {
            // ä½¿ç”¨æœ¬åœ°éŸ³æ•ˆæ–‡ä»¶
            const audio = new Audio();
            if (isSuccess) {
                audio.src = 'æ­£ç¡®æç¤ºéŸ³.mp3';
            } else {
                audio.src = 'é”™è¯¯æç¤ºéŸ³.mp3';
            }
            audio.play().catch(error => {
                console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', error);
                // å¦‚æœæ— æ³•æ’­æ”¾éŸ³æ•ˆï¼Œä½¿ç”¨å†…ç½®å£°éŸ³APIä½œä¸ºå¤‡é€‰
                fallbackPlaySound(isSuccess);
            });
        }

        // å¤‡é€‰å£°éŸ³æ’­æ”¾å‡½æ•°
        function fallbackPlaySound(isSuccess) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (isSuccess) {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } else {
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(110, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(55, audioContext.currentTime + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                }
            } catch (e) {
                console.error('æ— æ³•åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡:', e);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ æ¶ˆæ¯
        function showStatus(message) {
            statusBar.textContent = message;
            statusBar.className = 'text-gray-700';

            setTimeout(() => {
                if (statusBar.textContent === message) {
                    statusBar.textContent = 'å‡†å¤‡å°±ç»ª';
                    statusBar.className = 'text-gray-500';
                }
            }, 3000);
        }

        // æ˜¾ç¤ºä¿¡æ¯é¢æ¿
        function showInfo(message) {
            infoMessage.textContent = message;
            infoPanel.classList.remove('hidden');
            infoPanel.classList.add('flex');

            setTimeout(() => {
                infoPanel.classList.add('hidden');
                infoPanel.classList.remove('flex');
            }, 3000);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ£€æŸ¥æŒ‰é’®
            checkBtn.addEventListener('click', checkFoodChain);

            // çª—å£è°ƒæ•´å¤§å°æ—¶æ›´æ–°è¿æ¥çº¿
            window.addEventListener('resize', updateConnections);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            initLevelSelector();
            updateCreaturesContainer();
            initCanvasDrop();
            initEventListeners();
            levelInfo.textContent = `å½“å‰å…³å¡: ç¬¬${gameState.currentLevel}å…³`;
            showStatus('æ¸¸æˆå·²å‡†å¤‡å°±ç»ª');
        }

        // å¯åŠ¨æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
